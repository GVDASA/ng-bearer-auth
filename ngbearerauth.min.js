/**
 * ng-bearer-auth - Token-based AngularJS Authentication
 * @version v0.1.1
 * (c) 2015 Eduardo Eidelwein Berlitz
 * @link https://github.com/eberlitz/ng-bearer-auth
 * @license MIT
 */
!function(){"use strict";function e(e,t){var n;return{request:function(r){if(r.headers=r.headers||{},r.url&&!r.headers.Authorization&&!r.ignoreAuthInterceptor){n=n||e.get("$authProvider");var o=n.getByUrl(r.url);return o?o._authorizeRequest(r):r||t.when(r)}return r},responseError:function(e){if(401===e.status&&e.config){var r=n.getByUrl(e.config.url);if(r)return r.removeToken(),r._authorizeRequest(e.config,e)}return t.reject(e)}}}angular.module("ngBearerAuth",[]).factory("$authServiceInterceptor",e).factory("$auth",["$authProvider",function(e){var t=e.get("default");return t}]).factory("$authProvider",["$$authService",function(e){function t(t){var n=t.name=t.name||"default";if(n in o)throw"name "+n+" is already taken!";return o[n]=new e(t)}function n(e){if(!angular.isString(e))throw"Expected name to be a string! Found: "+typeof e+".";var t=o[e];return t?t:o["default"]}function r(e){if(!angular.isString(e))throw"Expected url to be a string! Found: "+typeof e+".";for(var t in o){var n=o[t];if(n.options.url&&0==e.indexOf(n.options.url))return n}return null}var o={},s={configure:t,get:n,getByUrl:r};return s}]).factory("$$authService",["$q","$http","$window",function(e,t,n){function r(e){var t=this;t.options=e}function o(n,r){var o=this,n=angular.extend({authorizeUrl:o.options.url+"token"},o.options,n),s=e.defer(),i={grant_type:n.username?"password":"client_credentials",username:n.username,password:n.password,client_id:n.clientId,client_secret:n.clientSecret},a=[];for(var u in i)null!=i[u]&&a.push(u+"="+i[u]);return r=angular.extend({ignoreAuthInterceptor:!0},r),t.post(n.authorizeUrl,a.join("&"),r).success(function(e){o.setToken(e,!!n.persistent),s.resolve(e)}).error(function(e){s.reject(e)}),s.promise}function s(){var e=this,t=e.isPersistent?n.localStorage:n.sessionStorage,r=["access_token","refresh_token","expires_at"];r.map(function(n){t.removeItem(e.options.name+"-"+n)})}function i(){return this._hasRefreshToken()||this._hasAccessToken()}function a(){return this.refresh_token=this._getData("refresh_token"),!!this.refresh_token}function u(){return this._hasRefreshToken()?this.refresh_token:null}function c(){var e=this,t=(new Date).getTime(),n=e._getData("expires_at");return e.access_token=n>t?e._getData("access_token"):void 0,!!e.access_token}function f(e){var t=this;return e=t.options.name+"-"+e,n.sessionStorage.getItem(e)||n.localStorage.getItem(e)}function h(){function t(e){return 400===e[1]&&"invalid_grant"===e[0].error}var n=this,r=e.defer();return n._hasAccessToken()?r.resolve(this.access_token):n._hasRefreshToken()?n._requestAccessToken().then(function(){r.resolve(n.access_token)},function(e){t(e)&&n.removeToken(),r.reject(e)}):r.reject("REQUEST_CREDENTIALS"),r.promise}function p(e,t){var r=this;"undefined"!=typeof r.isPersistent&&r.isPersistent!==!!t&&r.removeToken(),r.isPersistent=!!t;var o=r.isPersistent?n.localStorage:n.sessionStorage,s=(new Date).getTime(),i=s+1e3*parseInt(e.expires_in,10)-3e4,a={access_token:e.access_token,refresh_token:e.refresh_token||r._getData("refresh_token"),expires_at:i};for(var u in a)o.setItem(r.options.name+"-"+u,a[u]);r.access_token=a.access_token,r.refresh_token=a.refresh_token}function l(){var n=this,r=e.defer(),o=angular.extend({authorizeUrl:n.options.url+"token"},n.options),s={grant_type:"refresh_token",refresh_token:n.refresh_token,client_id:o.clientId,client_secret:o.clientSecret},i=[];for(var a in s)null!=s[a]&&i.push(a+"="+s[a]);var u=o.authorizeUrl;return n._hasPendingRequests()?n._addPendingRequest(r):(n._addPendingRequest(r),t.post(u,i.join("&"),{ignoreAuthInterceptor:!0}).success(function(e){n.setToken(s,!!o.persistent),n._resolveAllPendingRequest(!0,arguments)}).error(function(){n._resolveAllPendingRequest(!1,arguments)})),r.promise}function _(t,n){function r(e){e&&(t.headers.Authorization="Bearer "+e),a.resolve(t)}function o(){n?a.reject(n):r()}function s(e){return 400===e[1]&&"invalid_grant"===e[0].error}function i(){u.options.resourceOwnerCredentialsFn?(o(),u.options.resourceOwnerCredentialsFn(u.options)):u.options.client_id?u.options.clientCredentialsFn?u.options.clientCredentialsFn():r():u.authorize().then(function(){r(u.access_token)},function(){o()})}var a=e.defer(),u=this;return this.getToken().then(function(e){r(e)},function(e){"REQUEST_CREDENTIALS"===e||s(e)?i():o()}),a.promise}function d(e){var t=this;t._pendingRequests=t._pendingRequests||[],t._pendingRequests.push(e)}function g(){var e=this;return(e._pendingRequests||[]).length>0}function v(e,t){var n=this;(n._pendingRequests||[]).map(function(n){n[e?"resolve":"reject"].call(n,t)}),delete n._pendingRequests}return r.prototype.authorize=o,r.prototype.removeToken=s,r.prototype.isAuthenticated=i,r.prototype.getToken=h,r.prototype.setToken=p,r.prototype.getRefreshToken=u,r.prototype._authorizeRequest=_,r.prototype._hasRefreshToken=a,r.prototype._hasAccessToken=c,r.prototype._getData=f,r.prototype._requestAccessToken=l,r.prototype._addPendingRequest=d,r.prototype._hasPendingRequests=g,r.prototype._resolveAllPendingRequest=v,r}]),angular.module("ngBearerAuthInterceptor",["ngBearerAuth"]).config(["$httpProvider",function(e){e.interceptors.push("$authServiceInterceptor")}]),e.$inject=["$injector","$q"]}(window,window.angular);