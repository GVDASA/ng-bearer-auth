/**
 * ng-bearer-auth - Token-based AngularJS Authentication
 * @version v0.1.2
 * (c) 2015 Eduardo Eidelwein Berlitz
 * @link https://github.com/eberlitz/ng-bearer-auth
 * @license MIT
 */
!function(e,t){if("object"==typeof module&&module.exports)module.exports=t;else{if("object"!=typeof angular||!angular.module)throw new Error("Environment not supported!");angular.module("ngBearerAuth.service",[]).factory("$$storage",["$window",function(e){var t={getItem:function(t){return e.sessionStorage.getItem(t)||e.localStorage.getItem(t)},removeItem:function(t,n){var r=n?e.localStorage:e.sessionStorage;return r.removeItem(t)},setItem:function(t,n,r){var o=r?e.localStorage:e.sessionStorage;return o.setItem(t,n)}};return t}]).factory("$$authService",["$q","$http","$$storage",function(e,n,r){return t(e,n,r)}])}}(this,function(e,t,n){function r(e){var t=this;t.options=e}function o(n,r){var o=this,n=k({authorizeUrl:o.options.url+"token"},o.options,n),s=e.defer(),i={grant_type:n.username?"password":"client_credentials",username:n.username,password:n.password,client_id:n.clientId,client_secret:n.clientSecret},a=[];for(var u in i)null!=i[u]&&a.push(u+"="+i[u]);return r=k({ignoreAuthInterceptor:!0},r),t.post(n.authorizeUrl,a.join("&"),r).then(function(e){o.setToken(e.data,!!n.persistent),s.resolve(e.data)},function(e){s.reject(e.data)}),s.promise}function s(){var e=this,t=["access_token","refresh_token","expires_at"];t.map(function(t){n.removeItem(e.options.name+"-"+t,e.isPersistent)})}function i(){return this._hasRefreshToken()||this._hasAccessToken()}function a(){return this.refresh_token=this._getData("refresh_token"),!!this.refresh_token}function u(){return this._hasRefreshToken()?this.refresh_token:null}function c(){var e=this,t=(new Date).getTime(),n=e._getData("expires_at");return e.access_token=n>t?e._getData("access_token"):void 0,!!e.access_token}function f(e){var t=this;return e=t.options.name+"-"+e,n.getItem(e)}function h(){function t(e){return 400===e[1]&&"invalid_grant"===e[0].error}var n=this,r=e.defer();return n._hasAccessToken()?r.resolve(this.access_token):n._hasRefreshToken()?n._requestAccessToken().then(function(){r.resolve(n.access_token)},function(e){t(e)&&n.removeToken(),r.reject(e)}):r.reject("REQUEST_CREDENTIALS"),r.promise}function p(e,t){var r=this;"undefined"!=typeof r.isPersistent&&r.isPersistent!==!!t&&r.removeToken(),r.isPersistent=!!t;var o=(new Date).getTime(),s=o+1e3*parseInt(e.expires_in,10)-3e4,i={access_token:e.access_token,refresh_token:e.refresh_token||r._getData("refresh_token"),expires_at:s};for(var a in i)n.setItem(r.options.name+"-"+a,i[a],r.isPersistent);r.access_token=i.access_token,r.refresh_token=i.refresh_token}function l(){var n=this,r=e.defer(),o=k({authorizeUrl:n.options.url+"token"},n.options),s={grant_type:"refresh_token",refresh_token:n.refresh_token,client_id:o.clientId,client_secret:o.clientSecret},i=[];for(var a in s)null!=s[a]&&i.push(a+"="+s[a]);var u=o.authorizeUrl;return n._hasPendingRequests()?n._addPendingRequest(r):(n._addPendingRequest(r),t.post(u,i.join("&"),{ignoreAuthInterceptor:!0}).then(function(e){n.setToken(e.data,!!o.persistent),n._resolveAllPendingRequest(!0,arguments)},function(){n._resolveAllPendingRequest(!1,arguments)})),r.promise}function g(t,n){function r(e){e&&(t.headers.Authorization="Bearer "+e),a.resolve(t)}function o(){n?a.reject(n):r()}function s(e){return 400===e[1]&&"invalid_grant"===e[0].error}function i(){u.options.resourceOwnerCredentialsFn?(o(),u.options.resourceOwnerCredentialsFn(u.options)):u.options.client_id?u.options.clientCredentialsFn?u.options.clientCredentialsFn():r():u.authorize().then(function(){r(u.access_token)},function(){o()})}var a=e.defer(),u=this;return this.getToken().then(function(e){r(e)},function(e){"REQUEST_CREDENTIALS"===e||s(e)?i():o()}),a.promise}function d(e){var t=this;t._pendingRequests=t._pendingRequests||[],t._pendingRequests.push(e)}function _(){var e=this;return(e._pendingRequests||[]).length>0}function v(e,t){var n=this;(n._pendingRequests||[]).map(function(n){n[e?"resolve":"reject"].call(n,t)}),delete n._pendingRequests}function k(e){for(var t=1,n=arguments.length;n>t;t++){var r=arguments[t];if(r)for(var o=Object.keys(r),s=0,i=o.length;i>s;s++){var a=o[s];e[a]=r[a]}}return e}return r.prototype.authorize=o,r.prototype.removeToken=s,r.prototype.isAuthenticated=i,r.prototype.getToken=h,r.prototype.setToken=p,r.prototype.getRefreshToken=u,r.prototype._authorizeRequest=g,r.prototype._hasRefreshToken=a,r.prototype._hasAccessToken=c,r.prototype._getData=f,r.prototype._requestAccessToken=l,r.prototype._addPendingRequest=d,r.prototype._hasPendingRequests=_,r.prototype._resolveAllPendingRequest=v,r}),function(){"use strict";function e(e,t){var n;return{request:function(r){if(r.headers=r.headers||{},r.url&&!r.headers.Authorization&&!r.ignoreAuthInterceptor){n=n||e.get("$authProvider");var o=n.getByUrl(r.url);return o?o._authorizeRequest(r):r||t.when(r)}return r},responseError:function(e){if(401===e.status&&e.config){var r=n.getByUrl(e.config.url);if(r)return r.removeToken(),r._authorizeRequest(e.config,e)}return t.reject(e)}}}angular.module("ngBearerAuth",["ngBearerAuth.service"]).factory("$authServiceInterceptor",e).factory("$auth",["$authProvider",function(e){var t=e.get("default");return t}]).factory("$authProvider",["$$authService",function(e){function t(t){var n=t.name=t.name||"default";if(n in o)throw"name "+n+" is already taken!";return o[n]=new e(t)}function n(e){if(!angular.isString(e))throw"Expected name to be a string! Found: "+typeof e+".";var t=o[e];return t?t:o["default"]}function r(e){if(!angular.isString(e))throw"Expected url to be a string! Found: "+typeof e+".";for(var t in o){var n=o[t];if(n.options.url&&0==e.indexOf(n.options.url))return n}return null}var o={},s={configure:t,get:n,getByUrl:r};return s}]),angular.module("ngBearerAuthInterceptor",["ngBearerAuth"]).config(["$httpProvider",function(e){e.interceptors.push("$authServiceInterceptor")}]),e.$inject=["$injector","$q"]}(window,window.angular);